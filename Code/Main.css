#include <Arduino.h>
#include <TinyGPS++.h>
#include <HardwareSerial.h>
#include "radary.h"  

TinyGPSPlus gps;
HardwareSerial gpsSerial(2); // UART2 (GPIO16 = RX, GPIO17 = TX)

// jak daleko od radaru chceme upozornit (v metrech)
const double ALERT_DISTANCE = 100.0;

// pomocnÃ¡ funkce pro vÃ½poÄet vzdÃ¡lenosti mezi dvÄ›ma GPS body (v metrech)
double distanceMeters(double lat1, double lon1, double lat2, double lon2) {
  const double R = 6371000; // polomÄ›r ZemÄ› v metrech
  double dLat = radians(lat2 - lat1);
  double dLon = radians(lon2 - lon1);
  double a = sin(dLat / 2) * sin(dLat / 2) +
             cos(radians(lat1)) * cos(radians(lat2)) *
             sin(dLon / 2) * sin(dLon / 2);
  double c = 2 * atan2(sqrt(a), sqrt(1 - a));
  return R * c;
}

// pomocnÃ¡ promÄ›nnÃ¡ pro hlÃ¡Å¡enÃ­ radarÅ¯ (aby se neopakovaly kaÅ¾dou sekundu)
int lastRadarIndex = -1;

void setup() {
  Serial.begin(115200);
  delay(1000);
  Serial.println("ğŸ›°ï¸ SpouÅ¡tÃ­m GPS lokÃ¡tor radarÅ¯...");

  gpsSerial.begin(9600, SERIAL_8N1, 16, 17);
}

void loop() {
  while (gpsSerial.available() > 0) {
    gps.encode(gpsSerial.read());
  }

  if (gps.location.isUpdated()) {
    double lat = gps.location.lat();
    double lng = gps.location.lng();

    Serial.printf("ğŸ“ Poloha: %.6f, %.6f | Rychlost: %.1f km/h\n",
                  lat, lng, gps.speed.kmph());

    int nejblizsiRadar = -1;
    double minVzdalenost = 999999.0;

    // najdi nejbliÅ¾Å¡Ã­ radar
    for (int i = 0; i < POCET_RADARU; i++) {
      double radarLat = radary[i].lat;
      double radarLng = radary[i].lng;

      double vzdalenost = distanceMeters(lat, lng, radarLat, radarLng);

      if (vzdalenost < minVzdalenost) {
        minVzdalenost = vzdalenost;
        nejblizsiRadar = i;
      }
    }

    // pokud jsme dost blÃ­zko a nenÃ­ to ten samÃ½ radar jako minule â†’ upozorni
    if (nejblizsiRadar != -1 && minVzdalenost <= ALERT_DISTANCE && nejblizsiRadar != lastRadarIndex) {
      lastRadarIndex = nejblizsiRadar;
      Serial.println("âš ï¸  POZOR! Radar nablÃ­zku!");
      Serial.printf("ğŸ“ VzdÃ¡lenost: %.1f m\n", minVzdalenost);
      Serial.printf("ğŸ“ SouÅ™adnice radaru: %.6f, %.6f\n",
                    radary[nejblizsiRadar].lat, radary[nejblizsiRadar].lng);

      if (radary[nejblizsiRadar].maxSpeed > 0) {
        Serial.printf("ğŸš¦ Max rychlost: %d km/h\n", radary[nejblizsiRadar].maxSpeed);
      } else {
        Serial.println("ğŸš¦ Max rychlost: neuvedena");
      }

      Serial.println("----------------------------------");
    }

    delay(1000);
  }
}
 
